local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- GUI toggle
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.ResetOnSpawn = false

local btn = Instance.new("TextButton", gui)
btn.Size = UDim2.new(0, 220, 0, 48)
btn.Position = UDim2.new(0.5, -110, 0.5, -24)
btn.Text = "Auto Orb OFF"
btn.Font = Enum.Font.SourceSansBold
btn.TextSize = 18
btn.BackgroundColor3 = Color3.fromRGB(60, 120, 200) -- xanh khi OFF
btn.TextColor3 = Color3.fromRGB(255, 255, 255)
btn.Draggable = true

-- Biến
local running = false
local flight = { bp = nil, bg = nil, hrp = nil }
local SAFE_Y = 250       -- Độ cao an toàn
local ORB_Y_OFFSET = 5.2 -- Độ cao khi nhặt orb

-- Attach BodyPosition + BodyGyro
local function attachFlight(hrp)
	if flight.bp then flight.bp:Destroy() end
	if flight.bg then flight.bg:Destroy() end
	flight.hrp = hrp

	flight.bp = Instance.new("BodyPosition")
	flight.bp.MaxForce = Vector3.new(1e5, 1e5, 1e5)
	flight.bp.P = 30000
	flight.bp.D = 1000
	flight.bp.Position = hrp.Position
	flight.bp.Parent = hrp

	flight.bg = Instance.new("BodyGyro")
	flight.bg.MaxTorque = Vector3.new(1e5, 1e5, 1e5)
	flight.bg.P = 30000
	flight.bg.CFrame = hrp.CFrame
	flight.bg.Parent = hrp
end

local function detachFlight()
	if flight.bp then flight.bp:Destroy() end
	if flight.bg then flight.bg:Destroy() end
	flight.bp, flight.bg, flight.hrp = nil, nil, nil
end

-- Lấy danh sách orb
local function getOrbs()
	local container = workspace:FindFirstChild("OrbContainer_5370403716")
	local list = {}
	if container then
		for _, child in ipairs(container:GetChildren()) do
			if child.Name == "ChainOrb" then
				local part = child.PrimaryPart or child:FindFirstChildWhichIsA("BasePart")
				if part and part.Parent and part.Parent == child then
					table.insert(list, part)
				end
			end
		end
	end
	return list
end

-- Tìm orb gần nhất
local function getClosestOrb()
	local orbs = getOrbs()
	if #orbs == 0 then return nil end

	local closestOrb = nil
	local closestDist = math.huge
	local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return nil end

	for _, orb in ipairs(orbs) do
		local dist = (orb.Position - hrp.Position).Magnitude
		if dist < closestDist then
			closestDist = dist
			closestOrb = orb
		end
	end

	return closestOrb
end

-- Move tới vị trí chỉ định
local function moveToTarget(pos, yLevel)
	if not flight.bp then return end
	local finalPos = Vector3.new(pos.X, yLevel, pos.Z)
	flight.bp.Position = finalPos
end

-- Auto Orb loop
local function runAuto()
	local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then hrp = player.CharacterAdded:Wait():WaitForChild("HumanoidRootPart") end
	attachFlight(hrp)

	while running do
		local orb = getClosestOrb()
		if orb then
			moveToTarget(orb.Position, orb.Position.Y + ORB_Y_OFFSET)
		else
			moveToTarget(hrp.Position, SAFE_Y)
		end
		task.wait(0.5)
	end

	detachFlight()
end

-- Nút bật/tắt
btn.MouseButton1Click:Connect(function()
	running = not running
	if running then
		btn.Text = "Auto Orb ON"
		btn.BackgroundColor3 = Color3.fromRGB(200, 60, 60) -- đỏ khi ON
		task.spawn(runAuto)
	else
		btn.Text = "Auto Orb OFF"
		btn.BackgroundColor3 = Color3.fromRGB(60, 120, 200) -- xanh khi OFF
		detachFlight()
	end
end)

-- Khi respawn thì gắn lại flight nếu đang bật
player.CharacterAdded:Connect(function(char)
	if running then
		local hrp = char:WaitForChild("HumanoidRootPart")
		attachFlight(hrp)
	end
end)