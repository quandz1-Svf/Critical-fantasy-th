local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- GUI toggle
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.ResetOnSpawn = false

local btn = Instance.new("TextButton", gui)
btn.Size = UDim2.new(0, 220, 0, 48)
btn.Position = UDim2.new(0.5, -110, 0.5, -24)
btn.Text = "Auto Orb OFF"
btn.Font = Enum.Font.SourceSansBold
btn.TextSize = 18
btn.BackgroundColor3 = Color3.fromRGB(60, 120, 200)
btn.TextColor3 = Color3.fromRGB(255, 255, 255)
btn.Draggable = true

local running = false
local flight = { bp = nil, bg = nil, hrp = nil }

-- Các mức Y
local SAFE_Y = 151.7 -- cao an toàn khi đi nhặt orb
local IDLE_Y = 200   -- khi không còn orb thì bay cao hơn để né gai

-- Attach BodyPosition + BodyGyro
local function attachFlight(hrp)
	if flight.bp then flight.bp:Destroy() end
	if flight.bg then flight.bg:Destroy() end
	flight.hrp = hrp

	flight.bp = Instance.new("BodyPosition")
	flight.bp.MaxForce = Vector3.new(1e5, 1e5, 1e5)
	flight.bp.P = 30000
	flight.bp.D = 1000
	flight.bp.Position = hrp.Position
	flight.bp.Parent = hrp

	flight.bg = Instance.new("BodyGyro")
	flight.bg.MaxTorque = Vector3.new(1e5, 1e5, 1e5)
	flight.bg.P = 30000
	flight.bg.CFrame = hrp.CFrame
	flight.bg.Parent = hrp
end

local function detachFlight()
	if flight.bp then flight.bp:Destroy() end
	if flight.bg then flight.bg:Destroy() end
	flight.bp, flight.bg, flight.hrp = nil, nil, nil
end

-- Lấy danh sách orb
local function getOrbs()
	local container = workspace:FindFirstChild("OrbContainer_5370403716")
	local list = {}
	if container then
		for _, child in ipairs(container:GetChildren()) do
			if child.Name == "ChainOrb" then
				local part = child.PrimaryPart or child:FindFirstChildWhichIsA("BasePart")
				if part and part.Parent and part.Parent == child then
					table.insert(list, part)
				end
			end
		end
	end
	return list
end

-- Tìm orb gần nhất
local function getClosestOrb()
	local orbs = getOrbs()
	if #orbs == 0 then return nil end

	local closestOrb, closestDist
	local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return nil end

	for _, orb in ipairs(orbs) do
		local dist = (orb.Position - hrp.Position).Magnitude
		if not closestDist or dist < closestDist then
			closestDist = dist
			closestOrb = orb
		end
	end
	return closestOrb
end

-- Move to target (giữ Y cố định)
local function moveToTarget(pos, yLevel)
	if flight.bp then
		local finalPos = Vector3.new(pos.X, yLevel, pos.Z)
		flight.bp.Position = finalPos
	end
end

-- Auto loop
local function runAuto()
	while running do
		local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		if not hrp then
			hrp = player.CharacterAdded:Wait():WaitForChild("HumanoidRootPart")
		end
		if not flight.bp then
			attachFlight(hrp)
		end

		local orb = getClosestOrb()
		if orb and orb.Parent then
			-- Bay tới orb ở SAFE_Y
			moveToTarget(orb.Position, SAFE_Y)
		else
			-- Không có orb → bay cao lên
			moveToTarget(hrp.Position, IDLE_Y)
		end
		task.wait(0.5)
	end
end

btn.MouseButton1Click:Connect(function()
	running = not running
	btn.Text = running and "Auto Orb ON" or "Auto Orb OFF"

	if running then
		task.spawn(runAuto)
	else
		detachFlight()
	end
end)

player.CharacterAdded:Connect(function(char)
	if running then
		local hrp = char:WaitForChild("HumanoidRootPart")
		attachFlight(hrp)
	end
end)
